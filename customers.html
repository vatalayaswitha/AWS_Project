{% extends "base.html" %}
{% block title %}Customers - AWS AI Marketing{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold mb-0">
        <i class="fas fa-users text-primary me-3"></i>Customers ({{ customers|length }})
    </h1>
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
        <i class="fas fa-plus me-2"></i>Add Customer
    </button>
</div>

<div class="card shadow-lg border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>LTV</th>
                        <th>Preferences</th>
                        <th>AI Score</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar bg-primary me-3">
                                    {{ customer.name[0]|upper }}
                                </div>
                                <strong>{{ customer.name }}</strong>
                            </div>
                        </td>
                        <td>{{ customer.email }}</td>
                        <td><span class="badge bg-success">${{ "%.2f"|format(customer.lifetime_value) }}</span></td>
                        <td><span class="badge bg-info">{{ customer.preferences }}</span></td>
                        <td>
                            {# COMPLETE CSS FIX: Use data attribute + JS instead of inline style #}
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar bg-warning ai-progress-bar" 
                                     data-width="{{ [((customer.lifetime_value * 10)|int), 100]|min }}"></div>
                            </div>
                            <small class="text-muted mt-1 d-block ai-score-text" 
                                   data-score="{{ [((customer.lifetime_value * 10)|int), 100]|min }}">
                                Calculating...
                            </small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="getRecommendations('{{ customer.id }}')">
                                <i class="fas fa-brain"></i> AI Recs
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewCustomerDetails('{{ customer.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Customer Modal -->
<div class="modal fade" id="addCustomerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Add New Customer
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_customer') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Preferences</label>
                            <input type="text" class="form-control" name="preferences" placeholder="Fashion, Tech, Sports" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Lifetime Value ($)</label>
                            <input type="number" step="0.01" min="0" class="form-control" name="lifetime_value" value="100">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Customer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // FIX CSS LINTING: Set progress bars with pure JavaScript
    document.querySelectorAll('.ai-progress-bar').forEach(bar => {
        const width = parseInt(bar.dataset.width) || 0;
        bar.style.width = width + '%';
        bar.parentElement.querySelector('.ai-score-text').textContent = width + '%';
    });
});

function getRecommendations(customerId) {
    fetch(`/api/recommendations/${customerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                let message = 'ðŸ¤– AWS Personalize AI Recommendations:\n\n';
                message += `ðŸ“¦ Products: ${data.products.join(', ')}\n`;
                message += `ðŸ’¬ Content: ${data.content}\n`;
                message += `â° Urgency: ${data.urgency}`;
                alert(message);
            }
        })
        .catch(error => alert('Error: ' + error));
}

function viewCustomerDetails(customerId) {
    alert(`Customer Profile:\nID: ${customerId}\n\nFull analytics coming soon!`);
}
</script>
{% endblock %}
